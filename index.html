<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBfo4tviYF-mb8GP5GG7ElN7r_g0z94qO0",
    authDomain: "bi-developer-portfolio.firebaseapp.com",
    projectId: "bi-developer-portfolio",
    storageBucket: "bi-developer-portfolio.firebasestorage.app",
    messagingSenderId: "361759112211",
    appId: "1:361759112211:web:0dbebef7db5499768953e6",
    measurementId: "G-713BL1RHMP"
  };

  const appId = "mohd-ghouse-portfolio-master";

  let db, auth;

  const hideLoading = () => {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.style.opacity = "0";
      setTimeout(() => overlay.style.display = "none", 500);
    }
  };

  const safetyTimer = setTimeout(hideLoading, 2500);

  function applyCloudData(data) {
    const elements = {
      "p-img": data.portrait,
      "badge1-img": data.badge1,
      "badge2-img": data.badge2,
      "resume-link": data.resume
    };

    Object.entries(elements).forEach(([id, val]) => {
      if (val && (val.startsWith("data:") || val.startsWith("http"))) {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === "resume-link") el.href = val;
        else {
          el.src = val;
          el.classList.remove("hidden");
        }
      }
    });

    if (data.projectImages) {
      Object.keys(data.projectImages).forEach(id => {
        const el = document.getElementById(id + "-img");
        if (el && data.projectImages[id] && (data.projectImages[id].startsWith("data:") || data.projectImages[id].startsWith("http"))) {
          el.src = data.projectImages[id];
          el.classList.remove("hidden");
        }
      });
    }

    if (data.projectStatuses) {
      Object.keys(data.projectStatuses).forEach(id => {
        const el = document.getElementById(id + "-status");
        if (el) {
          el.innerText = data.projectStatuses[id];
          if (data.projectStatuses[id].includes("ACTIVE")) el.style.color = "#2563EB";
        }
      });
    }
  }

  window.saveToCloud = async function () {
    if (!auth || !auth.currentUser) {
      return alert("Auth not ready. Wait 2 seconds and try again.");
    }

    const btn = document.getElementById("save-btn");
    btn.innerText = "TRANSMITTING TO CLOUD...";
    btn.disabled = true;

    const payload = {
      portrait: document.getElementById("p-img")?.src || "",
      badge1: document.getElementById("badge1-img")?.src || "",
      badge2: document.getElementById("badge2-img")?.src || "",
      resume: document.getElementById("resume-link")?.href || "",
      projectImages: {
        p1: document.getElementById("p1-img")?.src || "",
        p2: document.getElementById("p2-img")?.src || "",
        p3: document.getElementById("p3-img")?.src || "",
        p4: document.getElementById("p4-img")?.src || "",
        p5: document.getElementById("p5-img")?.src || "",
        p6: document.getElementById("p6-img")?.src || ""
      },
      projectStatuses: {
        p1: document.getElementById("p1-status")?.innerText || "Offline",
        p2: document.getElementById("p2-status")?.innerText || "Offline",
        p3: document.getElementById("p3-status")?.innerText || "Offline",
        p4: document.getElementById("p4-status")?.innerText || "Offline",
        p5: document.getElementById("p5-status")?.innerText || "Offline",
        p6: document.getElementById("p6-status")?.innerText || "Offline"
      },
      timestamp: Date.now()
    };

    try {
      const docRef = doc(db, "artifacts", appId, "public", "data", "content", "portfolio");
      await setDoc(docRef, payload);
      alert("CLOUD SYNC SUCCESSFUL. Portfolio data is now globally persistent.");
      document.body.classList.remove("is-admin");
    } catch (e) {
      console.error("Save Error:", e);
      alert("SYNC ERROR: Firestore blocked OR payload too large (Max 1MB). Use smaller images.");
    } finally {
      btn.innerText = "Save Changes to Cloud";
      btn.disabled = false;
    }
  };

  try {
    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);

    // âœ… No top-level await (Fix blank page)
    signInAnonymously(auth)
      .then(() => {
        onAuthStateChanged(auth, (user) => {
          if (!user) return;

          const docRef = doc(db, "artifacts", appId, "public", "data", "content", "portfolio");

          onSnapshot(docRef, (docSnap) => {
            clearTimeout(safetyTimer);
            if (docSnap.exists()) applyCloudData(docSnap.data());
            hideLoading();
          }, (error) => {
            console.error("Cloud Access Error:", error);
            hideLoading();
          });
        });
      })
      .catch((err) => {
        console.error("Anonymous Auth Error:", err);
        hideLoading();
      });

  } catch (e) {
    console.error("Firebase Init Fail:", e);
    hideLoading();
  }
</script>
